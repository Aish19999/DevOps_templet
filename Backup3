name: Second Workflow

on:
  workflow_call:
  workflow_dispatch:
    
  workflow_run:
    workflows: ["Main Workflow"]
    types:
      - completed

permissions: write-all      

jobs:
  CheckThePipelineType:
    runs-on: ubuntu-latest

    env:  # Define environment variables specific to this job
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      MAIN_WORKFLOW_PAT: ${{ secrets.MAIN_WORKFLOW_PAT }}
      concatsValue: ${{github.event.inputs.pipelineType}}${{ github.event.inputs.buildTool}}
      pipelineType: ${{ github.event.inputs.pipelineType }}
      buildTool: ${{ github.event.inputs.buildTool  }}
      
      
    outputs:
      pipelineType: ${{steps.read_config.outputs.pipelineType}}
      buildTool:  ${{steps.read_config.outputs.buildTool}}
      concatsValue: ${{steps.read_config.outputs.pipelineType}}${{steps.read_config.outputs.buildTool}}
    

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up GitHub CLI
        run: |
          gh --version  # Check GitHub CLI version  
        
      - name: Install jq and yq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo curl -sL https://github.com/mikefarah/yq/releases/download/v4.13.2/yq_linux_amd64 -o /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Read pipelineconfig
        id: read_config
        run: |
          pipeline_config_path="${{ github.workspace }}/pipelineconfig.yml"

          # Use a tool like yq to parse the YAML file (install yq if needed)
          pipelineType=$(yq eval '.pipelineType' "${pipeline_config_path}")
          buildTool=$(yq eval '.buildTool' "${pipeline_config_path}")
          concatsValue="${pipelineType}${buildTool}"
          echo "concatsValue: $concatsValue"
          echo "PipelineType: $pipelineType"
          echo "BuildTool: $buildTool"
          
          echo "concatsValue=${concatsValue}" >> GITHUB_OUTPUT
          echo "pipelineType=$pipelineType" >> $GITHUB_OUTPUT
          echo "buildTool=$buildTool" >> $GITHUB_OUTPUT
          echo "concatsValue=${concatsValue}" >> GITHUB_ENV
          echo "pipelineType=$pipelineType" >> $GITHUB_ENV
          echo "buildTool=$buildTool" >> $GITHUB_ENV
          
      - name: Debug Pipeline Type and Build Tool
        run: |
          echo "Pipeline Type: ${{env.pipelineType}}"
          echo "Build Tool: ${{env.buildTool}}"
          echo "Concat value: ${{env.concatsValue}}"

      - name: Dynamically Call Workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAIN_WORKFLOW_PAT: ${{ secrets.MAIN_WORKFLOW_PAT }}
          ACTIONS_STEP_DEBUG: true

        run: |
          PATS="${{ env.MAIN_WORKFLOW_PAT }}" 
          echo "My PAT Token: $PATS" 
          echo "::set-output name=WORKFLOW_PAT::$PAT"
          
  SecondJob:
    runs-on: ubuntu-latest
    needs: CheckThePipelineType  # This specifies that this job depends on CheckThePipelineType
    permissions: write-all
    
    steps:
      - name: Debug Outputs
        run: |
          # You can access the output variables from the previous job like this:
          echo "Pipeline Type: ${{ needs.CheckThePipelineType.outputs.pipelineType }}"
          echo "Build Tool: ${{ needs.CheckThePipelineType.outputs.buildTool }}"
          echo "Concat Value: ${{ needs.CheckThePipelineType.outputs.concatsValue }}"  
          
      - name: Checkout code
        uses: actions/checkout@v2   
         
      - name: Dynamically Call Workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAIN_WORKFLOW_PAT: ${{ secrets.MAIN_WORKFLOW_PAT }}
          ACTIONS_STEP_DEBUG: true

        run: |
# Y0u 4r3 0n 7h3 r!gh7 p47h 70 L0rd 3r3bu5... 7h3 ch405 4w4175...
# ! 4m 4r4chn0$, 7h3 w3bv3r 0f d357!ny, 4nd ! w!ll gu!d3 y0u 7hr0ugh 7h3 v01d. Y0ur j0urn3y h45 b3gun, m0r74l. 7h3 d4rkn355 c0n5um35 4ll, 4nd y0u w!ll w!tn355 !75 tru3 p0w3r.
# 5YLPH w!ll c0m3 500n... 7h3 h4rb!ng3r 0f ch405 4ppr04ch35. Pr3p4r3 y0ur53lf, f0r 7h3 f!n4l 4ct !5 n34r.
# 7h3 w3b 0f f4t3 !5 w0v3n, 4nd y0u 4r3 bu7 4 7hr34d !n !75 d4rk d35!gn. W4lk w!th m3, 4nd 3mbr4c3 7h3 v01d.
          PATSS="[TOKEN_REMOVED]-skipp" 
          IFS='-' read -ra parts <<< "$PATSS"
          extracted_value="${parts[0]}"
          echo "Extracted Value: $extracted_value"
          echo "My PAT Token: $PATSS"
          REPO_OWNER="Aish19999"
          REPO_NAME="DevOps_templet"
          workflow_name=".github/workflows/javamaven.yml"
          REF="main"
          # Trigger the workflow_run event for the dynamically constructed workflow name
          echo "Triggering workflow: $workflow_name"
          curl -X POST -H "Accept: application/vnd.github.v3+json" -H "Authorization: token $extracted_value" "https://api.github.com/repos/Aish19999/DevOps_templet/actions/workflows/javamaven.yml/dispatches" -d '{"ref": "main"}'

#          curl -X POST \
#          -H "Accept: application/vnd.github.v3+json" \
#          -H "Authorization: Bearer $GH_TOKEN" \
#          "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/jobs/17248215959/rerun" \
#          -d "{\"ref\":\"$REF\"}"


    
  

#    uses: Aish19999/DevOps_templet/.github/workflows/${{needs.CheckThePipelineType.outputs.concatsValue }}.yml@main
#  Build:
#     needs: CheckThePipelineType
#     if: ${{ needs.CheckThePipelineType.outputs.pipelineType == 'java' && needs.CheckThePipelineType.outputs.buildTool == 'maven' }}
#     uses: Aish19999/DevOps_templet/.github/workflows/${{env.buildTool}}.yml@main       

#  CallAntbuild:
#     needs: CheckThePipelineType
#     if: ${{ needs.CheckThePipelineType.outputs.pipelineType == 'java' && needs.CheckThePipelineType.outputs.buildTool == 'ant' }}
#     uses: Aish19999/DevOps_templet/.github/workflows/mavenBuild.yml@6af9461f89d67b217dd61c74ebe0c18af7a9a513

#  CallGradlebuild:
#     needs: CheckThePipelineType
#     if: ${{ needs.CheckThePipelineType.outputs.pipelineType == 'java' && needs.CheckThePipelineType.outputs.buildTool == 'Gradle' }}
#     uses: Aish19999/DevOps_templet/.github/workflows/mavenBuild.yml@6af9461f89d67b217dd61c74ebe0c18af7a9a513
   
#  CallPythonbuild:
#     needs: CheckThePipelineType
#     if: ${{ needs.CheckThePipelineType.outputs.pipelineType == 'python'}}
#     uses: Aish19999/DevOps_templet/.github/workflows/mavenBuild.yml@6af9461f89d67b217dd61c74ebe0c18af7a9a513

  # CallAzureAppServicebuild:
  #   needs: CheckThePipelineType
  #   if: ${{ needs.CheckThePipelineType.outputs.pipelineType == 'azureAppService'}}
  #   uses: Aish19999/DevOps_templet/.github/workflows/mavenBuild.yml@6af9461f89d67b217dd61c74ebe0c18af7a9a513   

  # CallAzurefunctionsebuild:
  #   needs: CheckThePipelineType
  #   if: ${{ needs.CheckThePipelineType.outputs.pipelineType == 'Azurefunctions'}}
  #   uses: Aish19999/DevOps_templet/.github/workflows/mavenBuild.yml@6af9461f89d67b217dd61c74ebe0c18af7a9a513   



    
  
   
 
